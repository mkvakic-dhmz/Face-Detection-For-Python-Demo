Bootstrap: docker
From: nvcr.io/nvidia/cuda:12.9.1-runtime-ubuntu22.04

%files
    requirements.txt /opt/dwd/requirements.txt
    face.py /opt/dwd/face.py

%post
    # Install base packages
    export DEBIAN_FRONTEND=noninteractive && \
    apt-get update && apt-get install -y \
        git \
        python3 \
        python3-venv \
        && rm -rf /var/lib/apt/lists/*

    # Set up virtual environment
    python3 -m venv /opt/dwd/venv && \
        . /opt/dwd/venv/bin/activate && \
        pip install --upgrade pip && \
        pip install -r /opt/dwd/requirements.txt && \
        pip uninstall onnxruntime -y && \
        pip install onnxruntime-gpu && \
        pip cache purge

    # Change face.py's permissions
    chmod 755 /opt/dwd/face.py

%environment
    . /opt/dwd/venv/bin/activate
    export CUDA_HOME=/usr/local/cuda

%runscript
    exec /opt/nvidia/nvidia_entrypoint.sh /opt/dwd/face.py "$@"
